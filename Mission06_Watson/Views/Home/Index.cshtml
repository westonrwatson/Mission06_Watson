<!-- Weston Watson, Section 3 -->

@model IEnumerable<Mission06_Watson.Models.Movie>

@{
    ViewData["Title"] = "The Joel Hilton Film Collection";
}

<!-- Success Message -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

<!-- Retained from previous Mission 6 -->
<h1>The Joel Hilton Film Collection</h1>
<img src="/joel.jpg" alt="Baconsale" width="400">

<!-- New Table to display Movies + Bootstrap theme-->
<table class="table table-hover table-bordered">
    <thead class="table-dark">
    <tr>
        <th>Title</th>
        <th>Category</th>
        <th>Year</th>
        <th>Director</th>
        <th>Rating</th>
        <th>Edited</th>
        <th>Lent To</th>
        <th>Notes</th>
        <th>Copied To Plex</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var movie in Model)
    {
        <tr id="row-@movie.MovieId">
            <td>
                <span class="view-mode">@movie.Title</span>
                <input type="text" name="Title" class="edit-mode form-control" value="@movie.Title" hidden>
            </td>

            <td>
                <span class="view-mode">@movie.Category?.CategoryName</span>
                <select name="CategoryId" class="edit-mode form-control" asp-items="ViewBag.Categories" hidden>
                    <option value="@movie.CategoryId">-- Select Category --</option>
                </select>
            </td>

            <td>
                <span class="view-mode">@((movie.Year ?? 2000).ToString())</span>
                <input type="number" name="Year" class="edit-mode form-control" value="@(movie.Year ?? 2000)" min="1888" max="2100" hidden>
            </td>

            <td>
                <span class="view-mode">@movie.Director</span>
                <input type="text" name="Director" class="edit-mode form-control" value="@movie.Director" hidden>
            </td>

            <td>
                <span class="view-mode">@movie.Rating</span>
                <select name="Rating" class="edit-mode form-control" hidden>
                    <option value="G" selected="@(movie.Rating == "G" ? "selected" : null)">G</option>
                    <option value="PG" selected="@(movie.Rating == "PG" ? "selected" : null)">PG</option>
                    <option value="PG-13" selected="@(movie.Rating == "PG-13" ? "selected" : null)">PG-13</option>
                    <option value="R" selected="@(movie.Rating == "R" ? "selected" : null)">R</option>
                </select>
            </td>

            <td>
                <span class="view-mode">@movie.LentTo</span>
                <input type="text" name="LentTo" class="edit-mode form-control" value="@movie.LentTo" hidden>
            </td>

            <td>
                <span class="view-mode">@movie.Notes</span>
                <input type="text" name="Notes" class="edit-mode form-control" value="@movie.Notes" maxlength="25" hidden>
            </td>

            <td>
                <span class="view-mode">@(movie.Edited ? "Yes" : "No")</span>
                <input type="checkbox" name="Edited" class="edit-mode" @(movie.Edited ? "checked" : "") hidden>
            </td>

            <td>
                <span class="view-mode">@(movie.CopiedToPlex ? "Yes" : "No")</span>
                <input type="checkbox" name="CopiedToPlex" class="edit-mode" @(movie.CopiedToPlex ? "checked" : "") hidden>
            </td>

            <td>
                <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                <button class="btn btn-success btn-sm save-btn" data-id="@movie.MovieId" hidden>Save</button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="@movie.MovieId">Delete</button>
            </td>
        </tr>
    }
    </tbody>
</table>

<!-- JS to help reduce pages and allow for editting on the index page -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $(".edit-btn").click(function () {
            var row = $(this).closest("tr");
            row.find(".view-mode").hide();
            row.find(".edit-mode").prop("hidden", false);
            row.find(".edit-btn").hide();
            row.find(".save-btn").prop("hidden", false);
        });

        $(".save-btn").click(function () {
            var row = $(this).closest("tr");
            var movieId = $(this).data("id");

            var updatedMovie = {
                MovieId: movieId,
                Title: row.find("input[name='Title']").val().trim(),
                CategoryId: row.find("select[name='CategoryId'] option:selected").val(), // ✅ Corrected dropdown selection
                Year: parseInt(row.find("input[name='Year']").val().trim()) || 2000, // ✅ Ensures valid int
                Director: row.find("input[name='Director']").val().trim(),
                Rating: row.find("select[name='Rating']").val(),
                Edited: row.find("input[name='Edited']").is(":checked"),
                LentTo: row.find("input[name='LentTo']").val()?.trim() || null,
                Notes: row.find("input[name='Notes']").val()?.trim() || null,
                CopiedToPlex: row.find("input[name='CopiedToPlex']").is(":checked")
            };

            console.log("Sending updated data:", updatedMovie);

            $.ajax({
                url: '/Home/UpdateMovie',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(updatedMovie),
                success: function () {
                    location.reload();
                },
                error: function (xhr, status, error) {
                    alert("Error updating movie: " + xhr.responseText);
                }
            });
        });

        $(".delete-btn").click(function () {
            var movieId = $(this).data("id");
            if (confirm("Are you sure you want to delete this movie?")) {
                $.post('/Home/DeleteMovie', { id: movieId }, function () {
                    location.reload();
                }).fail(function () {
                    alert("Error deleting movie.");
                });
            }
        });
    });
</script>
